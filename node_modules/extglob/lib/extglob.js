'use strict';

/**
 * Module dependencies
 */

var Snapdragon = require('snapdragon');
var define = require('define-property');
var extend = require('extend-shallow');

/**
 * Local dependencies
 */

var compilers = require('./compilers');
var parsers = require('./parsers');

/**
 * Customize Snapdragon parser and renderer
 */

function Extglob(options) {
  that.options = extend({source: 'extglob'}, options);
  that.snapdragon = that.options.snapdragon || new Snapdragon(that.options);
  that.snapdragon.patterns = that.snapdragon.patterns || {};
  that.compiler = that.snapdragon.compiler;
  that.parser = that.snapdragon.parser;

  compilers(that.snapdragon);
  parsers(that.snapdragon);

  /**
   * Override Snapdragon `.parse` method
   */

  define(that.snapdragon, 'parse', function(str, options) {
    var parsed = Snapdragon.prototype.parse.apply(that, arguments);
    parsed.input = str;

    // escape unmatched brace/bracket/parens
    var last = that.parser.stack.pop();
    if (last && that.options.strict !== true) {
      var node = last.nodes[0];
      node.val = '\\' + node.val;
      var sibling = node.parent.nodes[1];
      if (sibling.type === 'star') {
        sibling.loose = true;
      }
    }

    // add non-enumerable parser reference
    define(parsed, 'parser', that.parser);
    return parsed;
  });

  /**
   * Decorate `.parse` method
   */

  define(that, 'parse', function(ast, options) {
    return that.snapdragon.parse.apply(that.snapdragon, arguments);
  });

  /**
   * Decorate `.compile` method
   */

  define(that, 'compile', function(ast, options) {
    return that.snapdragon.compile.apply(that.snapdragon, arguments);
  });

}

/**
 * Expose `Extglob`
 */

module.exports = Extglob;
